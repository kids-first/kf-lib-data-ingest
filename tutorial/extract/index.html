

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Extract Stage &mdash; Kids First Data Ingest Libraries  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/other.css" type="text/css" />
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Testing Your Ingest Package" href="../testing.html" />
    <link rel="prev" title="New Ingest Package Setup" href="../ingest_package.html" />
    <link rel="stylesheet" href="https://kids-first.github.io/kf-sphinx-docs-theme/sphinx_kidsfirst_theme/static/css/kidsfirst.css" type="text/css" />
 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/overview.html">Design Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../app.html">Kids First Ingest App</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ingest_package.html">New Ingest Package Setup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Extract Stage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-extract-configuration">Example Extract Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#here-s-an-example-source-data-file">Here’s an example source data file:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-order-to-ingest-this-data-into-the-kids-first-ecosystem-we-will-need-to">In order to ingest this data into the Kids First ecosystem, we will need to:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-following-extract-configuration-file-accomplishes-all-of-those-needs">The following extract configuration file accomplishes all of those needs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#imports">Imports!</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fetching-the-data">Fetching the data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-the-file">Reading the file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extract-operations">Extract operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-final-extraction-product">The final Extraction product</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#preprocessing-before-the-operations-list">Preprocessing Before the Operations List</a></li>
<li class="toctree-l3"><a class="reference internal" href="#files-that-need-custom-readers">Files That Need Custom Readers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#predefined-mapping-operations">Predefined Mapping Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#keep-map">Keep Map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constant-map">Constant Map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#value-map">Value Map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#row-map">Row Map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#column-map">Column Map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#melt-map">Melt Map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#df-map">DF Map</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#important-strategic-details">Important Strategic Details</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#avoid-hard-coded-strings">Avoid Hard-coded Strings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#repeated-information">Repeated Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#you-don-t-need-to-extract-the-whole-document-all-at-once">You Don’t Need To Extract The Whole Document All At Once</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parallel-column-stacking">Parallel Column Stacking</a></li>
<li class="toctree-l4"><a class="reference internal" href="#length-rectification">Length Rectification</a></li>
<li class="toctree-l4"><a class="reference internal" href="#splitting-cells">Splitting Cells</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nested-operations-sublists">Nested Operations Sublists</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html">Testing Your Ingest Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="challenge_scenarios/index.html">Common Challenges when Extracting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sourcing_data/index.html">Sourcing Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transform.html">Transform Stage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../target_service_plugins/index.html">Target Service Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../load.html">Understanding the Load Stage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Kids First Data Ingest Libraries</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Tutorial</a> &raquo;</li>
        
      <li>Extract Stage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tutorial/extract/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="extract-stage">
<span id="tutorial-extract-stage"></span><h1>Extract Stage<a class="headerlink" href="#extract-stage" title="Permalink to this heading">¶</a></h1>
<p>The extract stage does 3 main things:</p>
<ol class="arabic simple">
<li><p>Select the desired subset of data from the source data files</p></li>
<li><p>Clean the selected data (remove trailing whitespaces, etc)</p></li>
<li><p>Map the cleaned data’s attributes and values to Kids First entity attributes
and acceptable values.</p></li>
</ol>
<p>The extract configuration files instruct the extract stage how to accomplish
the above.</p>
<section id="example-extract-configuration">
<span id="extract-example"></span><h2>Example Extract Configuration<a class="headerlink" href="#example-extract-configuration" title="Permalink to this heading">¶</a></h2>
<p>Every data file provided by the investigator will require at least one extract
configuration file. The reasons why will hopefully become clear after reading
this section.</p>
<p>We will step through how to write an extract configuration file for a source
data file.</p>
<section id="here-s-an-example-source-data-file">
<h3>Here’s an example source data file:<a class="headerlink" href="#here-s-an-example-source-data-file" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">family_and_phenotype.tsv</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
<th class="head"><p>[ignore]</p></th>
</tr>
<tr class="row-even"><th class="head"><p>[ignore]</p></th>
<th class="head"><p>participant</p></th>
<th class="head"><p>mother</p></th>
<th class="head"><p>father</p></th>
<th class="head"><p>gender</p></th>
<th class="head"><p>specimens</p></th>
<th class="head"><p>age (hrs)</p></th>
<th class="head"><p>CLEFT_EGO</p></th>
<th class="head"><p>CLEFT_ID</p></th>
<th class="head"><p>age (hrs)</p></th>
<th class="head"><p>EXTRA_EARDRUM</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>[ignore]</p></td>
<td><p>PID001</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>F</p></td>
<td><p>SP001A,SP001B</p></td>
<td><p>4</p></td>
<td><p>TRUE</p></td>
<td><p>FALSE</p></td>
<td><p>4</p></td>
<td><p>FALSE</p></td>
</tr>
<tr class="row-even"><td><p>[ignore]</p></td>
<td><p>PID002</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP002A; SP002B</p></td>
<td><p>435</p></td>
<td><p>TRUE</p></td>
<td><p>FALSE</p></td>
<td><p>435</p></td>
<td><p>FALSE</p></td>
</tr>
<tr class="row-odd"><td><p>[ignore]</p></td>
<td><p>PID003</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP003A;SP003B</p></td>
<td><p>34</p></td>
<td><p>TRUE</p></td>
<td><p>FALSE</p></td>
<td><p>34</p></td>
<td><p>FALSE</p></td>
</tr>
<tr class="row-even"><td><p>[ignore]</p></td>
<td><p>PID004</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
<td><p>M</p></td>
<td><p>SP004A; SP004B</p></td>
<td><p>4</p></td>
<td><p>TRUE</p></td>
<td><p>TRUE</p></td>
<td><p>4</p></td>
<td><p>FALSE</p></td>
</tr>
<tr class="row-odd"><td><p>[ignore]</p></td>
<td><p>PID005</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP005A, SP005B</p></td>
<td><p>345</p></td>
<td><p>TRUE</p></td>
<td><p>TRUE</p></td>
<td><p>34</p></td>
<td><p>FALSE</p></td>
</tr>
<tr class="row-even"><td><p>[ignore]</p></td>
<td><p>PID006</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP006</p></td>
<td><p>34</p></td>
<td><p>TRUE</p></td>
<td><p>TRUE</p></td>
<td><p>43545</p></td>
<td><p>FALSE</p></td>
</tr>
<tr class="row-odd"><td><p>[ignore]</p></td>
<td><p>PID007</p></td>
<td><p>8</p></td>
<td><p>9</p></td>
<td><p>M</p></td>
<td><p>SP007</p></td>
<td><p>34</p></td>
<td><p>TRUE</p></td>
<td><p>FALSE</p></td>
<td><p>5</p></td>
<td><p>TRUE</p></td>
</tr>
<tr class="row-even"><td><p>[ignore]</p></td>
<td><p>PID008</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP008A,SP008B</p></td>
<td><p>43545</p></td>
<td><p>TRUE</p></td>
<td><p>TRUE</p></td>
<td><p>52</p></td>
<td><p>TRUE</p></td>
</tr>
<tr class="row-odd"><td><p>[ignore]</p></td>
<td><p>PID009</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP009A,SP009B</p></td>
<td><p>5</p></td>
<td><p>FALSE</p></td>
<td><p>TRUE</p></td>
<td><p>25</p></td>
<td><p>TRUE</p></td>
</tr>
</tbody>
</table>
</section>
<section id="in-order-to-ingest-this-data-into-the-kids-first-ecosystem-we-will-need-to">
<h3>In order to ingest this data into the Kids First ecosystem, we will need to:<a class="headerlink" href="#in-order-to-ingest-this-data-into-the-kids-first-ecosystem-we-will-need-to" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Ignore everything marked with [ignore], meaning our table actually starts at
the second row and second column</p></li>
<li><p>Convert the column headers into a standardized set of concepts that the
toolchain can understand. The values are defined in the Standard Concept
Schema located in
<code class="docutils literal notranslate"><span class="pre">kf_lib_data_ingest.common.concept_schema.CONCEPT</span></code></p></li>
<li><p>Unify the formats of the participant IDs and the mother/father IDs</p></li>
<li><p>Convert the M and F in the gender column to standardized values for
Male/Female found in <code class="docutils literal notranslate"><span class="pre">kf_lib_data_ingest.common.constants</span></code>, because we want
to use standard constant codes wherever possible.</p></li>
<li><p>Split delimited specimens apart into their own rows</p></li>
<li><p>Convert age (hrs) to age in days</p></li>
<li><p>Reshape the CLEFT_EGO, CLEFT_ID, and EXTRA_EARDRUM columns into observation
events</p></li>
<li><p>Convert the TRUE and FALSE strings into standardized observation codes</p></li>
</ul>
</section>
<section id="the-following-extract-configuration-file-accomplishes-all-of-those-needs">
<h3>The following extract configuration file accomplishes all of those needs<a class="headerlink" href="#the-following-extract-configuration-file-accomplishes-all-of-those-needs" title="Permalink to this heading">¶</a></h3>
<p>(We will explain how each piece works after showing the whole thing)</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">family_and_phenotype.py</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.common</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.common.concept_schema</span> <span class="kn">import</span> <span class="n">CONCEPT</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.common.pandas_utils</span> <span class="kn">import</span> <span class="n">Split</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.etl.extract.operations</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">source_data_url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/kids-first/kf-lib-data-ingest/master/docs/data/family_and_phenotype.tsv&quot;</span>

<span class="n">source_data_read_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;usecols&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;[ignore]&quot;</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">observed_yes_no</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">YES</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">NO</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">}:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">value_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;participant&quot;</span><span class="p">,</span>
        <span class="n">m</span><span class="o">=</span><span class="p">{</span>
            <span class="sa">r</span><span class="s2">&quot;PID(\d+)&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>  <span class="c1"># strip PID and 0-padding</span>
        <span class="p">},</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PARTICIPANT</span><span class="o">.</span><span class="n">ID</span>
    <span class="p">),</span>
    <span class="n">keep_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;mother&quot;</span><span class="p">,</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PARTICIPANT</span><span class="o">.</span><span class="n">MOTHER_ID</span>
    <span class="p">),</span>
    <span class="n">keep_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;father&quot;</span><span class="p">,</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PARTICIPANT</span><span class="o">.</span><span class="n">FATHER_ID</span>
    <span class="p">),</span>
    <span class="n">value_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span>
        <span class="c1"># Don&#39;t worry about mother/father gender here.</span>
        <span class="c1"># We can create them in a later phase.</span>
        <span class="n">m</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">GENDER</span><span class="o">.</span><span class="n">FEMALE</span><span class="p">,</span>
            <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">GENDER</span><span class="o">.</span><span class="n">MALE</span>
        <span class="p">},</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PARTICIPANT</span><span class="o">.</span><span class="n">GENDER</span>
    <span class="p">),</span>
    <span class="n">value_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;specimens&quot;</span><span class="p">,</span>
        <span class="n">m</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Split</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[,;]&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">BIOSPECIMEN</span><span class="o">.</span><span class="n">ID</span>
    <span class="p">),</span>
    <span class="p">[</span>
        <span class="n">value_map</span><span class="p">(</span>
            <span class="n">in_col</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>  <span class="c1"># age (hrs) (first)</span>
            <span class="n">m</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
            <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">EVENT_AGE_DAYS</span>
        <span class="p">),</span>
        <span class="n">melt_map</span><span class="p">(</span>
            <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
            <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;CLEFT_EGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft ego&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CLEFT_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft id&quot;</span>
            <span class="p">},</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
            <span class="n">map_for_values</span><span class="o">=</span><span class="n">observed_yes_no</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="p">[</span>
        <span class="n">value_map</span><span class="p">(</span>
            <span class="n">in_col</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>  <span class="c1"># age (hrs) (second)</span>
            <span class="n">m</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
            <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">EVENT_AGE_DAYS</span>
        <span class="p">),</span>
        <span class="n">melt_map</span><span class="p">(</span>
            <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
            <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;EXTRA_EARDRUM&quot;</span><span class="p">:</span> <span class="s2">&quot;Extra eardrum&quot;</span>
            <span class="p">},</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
            <span class="n">map_for_values</span><span class="o">=</span><span class="n">observed_yes_no</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>First, download <a class="reference download internal" download="" href="../../_downloads/0e9d418c30dd6481f9e51ae418dccadb/family_and_phenotype.py"><code class="xref download docutils literal notranslate"><span class="pre">family_and_phenotype.py</span></code></a>
and put it in the extract_configs directory like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>my_study/
└── ingest_package_1/
    └── extract_configs/
       └── family_and_phenotype.py
</pre></div>
</div>
<p>Now let’s break down how it works…</p>
</section>
<section id="imports">
<h3>Imports!<a class="headerlink" href="#imports" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.common</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.common.concept_schema</span> <span class="kn">import</span> <span class="n">CONCEPT</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.common.pandas_utils</span> <span class="kn">import</span> <span class="n">Split</span>
<span class="kn">from</span> <span class="nn">kf_lib_data_ingest.etl.extract.operations</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>It’s a Python module! Cool! That lets us do all kinds of neat stuff like import
predefined constants and functions and use arbitrarily complex function code to
process our data.</p>
</section>
<section id="fetching-the-data">
<span id="id1"></span><h3>Fetching the data<a class="headerlink" href="#fetching-the-data" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">source_data_url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/kids-first/kf-lib-data-ingest/master/docs/data/family_and_phenotype.tsv&quot;</span>
</pre></div>
</div>
<p>The first thing that the extractor does for every config file is fetch the
related source data. This specifies where the file lives so that the code can
fetch it.</p>
<p>Supported protocol prefixes are:
<code class="docutils literal notranslate"><span class="pre">file://</span></code>, <code class="docutils literal notranslate"><span class="pre">s3://</span></code>, <code class="docutils literal notranslate"><span class="pre">http://</span></code>, <code class="docutils literal notranslate"><span class="pre">https://</span></code></p>
<p>For files stored by the Kids First Data Tracker, see the
“<a class="reference internal" href="../sourcing_data/study_creator.html#tutorial-study-creator"><span class="std std-ref">Source Data stored by the Kids First Data Tracker</span></a>” tutorial.</p>
<p>If you downloaded the test data file and want to load your local copy instead
of from a remote server, you would use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">source_data_url</span> <span class="o">=</span> <span class="s2">&quot;file://path/to/family_and_phenotype.tsv&quot;</span>
</pre></div>
</div>
</section>
<section id="reading-the-file">
<h3>Reading the file<a class="headerlink" href="#reading-the-file" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">source_data_read_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;usecols&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;[ignore]&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Extract tries to automatically pick the right pandas file reader for the given
file extension (read_json for json files, read_csv for csv/tsv, read_excel for
excel files), but sometimes the reader needs guidance from input parameters. To
pass keyword parameters to the file reader, we define a dict called
<code class="docutils literal notranslate"><span class="pre">source_data_read_params</span></code> which corresponds with the Python pandas IO
parameters described in
<a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/user_guide/io.html">http://pandas.pydata.org/pandas-docs/stable/user_guide/io.html</a></p>
<p>The example data file contains tab-separated values (hence the filename ending
with “.tsv”) with a non-standard layout where we need to ignore the first row
and the first column.</p>
<p>If the data had had the simplest layout (the column headers being on the first
row, etc), then it would get loaded correctly by default without needing any
parameters here, but with complex arrangements we have to configure the reader.</p>
</section>
<section id="extract-operations">
<h3>Extract operations<a class="headerlink" href="#extract-operations" title="Permalink to this heading">¶</a></h3>
<section id="the-operations-list">
<h4>The operations list<a class="headerlink" href="#the-operations-list" title="Permalink to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>This is a list of special functions that the extract stage will execute to
select subsets of source data and then clean and map that data to the desired
attributes and value formats. The most useful functions are already written for
you. You just have to invoke them appropriately.</p>
<p>For more information about extract operation functions, read
<a class="reference internal" href="#map-operations"><span class="std std-ref">Predefined Mapping Operations</span></a>.</p>
</section>
<section id="a-value-map-operation-with-functional-replacements">
<h4>A value map operation with functional replacements<a class="headerlink" href="#a-value-map-operation-with-functional-replacements" title="Permalink to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">value_map</span><span class="p">(</span>
    <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;participant&quot;</span><span class="p">,</span>
    <span class="n">m</span><span class="o">=</span><span class="p">{</span>
        <span class="sa">r</span><span class="s2">&quot;PID(\d+)&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>  <span class="c1"># strip PID and 0-padding</span>
    <span class="p">},</span>
    <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PARTICIPANT</span><span class="o">.</span><span class="n">ID</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This says “Use the <code class="docutils literal notranslate"><span class="pre">&quot;participant&quot;</span></code> column as input, replace everything that
matches (<code class="docutils literal notranslate"><span class="pre">m={...}</span></code>) the regular expression pattern <code class="docutils literal notranslate"><span class="pre">^PID(\d+)$</span></code> with just
the captured part and remove the zero padding by running the captured part
through the function <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">int(x)</span></code>, and then output the result to a
standard concept column for the participant ID.”</p>
<p>The resulting intermediate output will look like:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>index</p></th>
<th class="head"><p>&lt;CONCEPT.PARTICIPANT.ID&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>8</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>9</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">int(x)</span></code> could be replaced by just <code class="docutils literal notranslate"><span class="pre">int</span></code>, since the two
expressions are functionally equivalent (both single-argument functions that
effectively strip the leading zeros).</p>
<p>We could also have kept these IDs as they were and instead converted the
mother/father IDs, but, in the absence of an overriding directive such as input
from the investigators about their preferences, it doesn’t really make a
difference which way we choose.</p>
</section>
<section id="a-keep-the-original-values-map-operation">
<h4>A keep-the-original-values map operation<a class="headerlink" href="#a-keep-the-original-values-map-operation" title="Permalink to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">keep_map</span><span class="p">(</span>
    <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;mother&quot;</span><span class="p">,</span>
    <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PARTICIPANT</span><span class="o">.</span><span class="n">MOTHER_ID</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This says “Put all of the values from the <code class="docutils literal notranslate"><span class="pre">&quot;mother&quot;</span></code> column into a standard
concept column for the ID of the participant’s mother, but keep all of the
values the same.” <code class="docutils literal notranslate"><span class="pre">keep_map</span></code> is the same as a <code class="docutils literal notranslate"><span class="pre">value_map</span></code> where every value
is mapped to itself.</p>
<p>The resulting intermediate output will look like:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>index</p></th>
<th class="head"><p>&lt;CONCEPT.PARTICIPANT.MOTHER_ID&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>8</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="a-value-map-operation-with-variable-replacements">
<h4>A value map operation with variable replacements<a class="headerlink" href="#a-value-map-operation-with-variable-replacements" title="Permalink to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">value_map</span><span class="p">(</span>
    <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span>
    <span class="n">m</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">GENDER</span><span class="o">.</span><span class="n">FEMALE</span><span class="p">,</span>
        <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">GENDER</span><span class="o">.</span><span class="n">MALE</span>
    <span class="p">},</span>
    <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PARTICIPANT</span><span class="o">.</span><span class="n">GENDER</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This says “Use the <code class="docutils literal notranslate"><span class="pre">gender</span></code> column as input, replace everything that matches
the regular expression pattern <code class="docutils literal notranslate"><span class="pre">^F$</span></code> with the standard code for Female and
replace everything that matches <code class="docutils literal notranslate"><span class="pre">^M$</span></code> with the standard code for Male, and
then output the result to a standard concept column for participant gender.”</p>
<p>The resulting intermediate output will look like:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>index</p></th>
<th class="head"><p>&lt;CONCEPT.PARTICIPANT.ID&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Female</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Male</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>Male</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="a-value-map-that-splits-cells-apart">
<h4>A value map that splits cells apart<a class="headerlink" href="#a-value-map-that-splits-cells-apart" title="Permalink to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">value_map</span><span class="p">(</span>
    <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;specimens&quot;</span><span class="p">,</span>
    <span class="n">m</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Split</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[,;]&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span>
    <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">BIOSPECIMEN</span><span class="o">.</span><span class="n">ID</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This says “Use the <code class="docutils literal notranslate"><span class="pre">specimens</span></code> column as input, split any <code class="docutils literal notranslate"><span class="pre">,</span></code> or <code class="docutils literal notranslate"><span class="pre">;</span></code>
delimited values apart into their own entries, and then output the result to a
standard concept column for biospecimen ID.”</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We use the special <code class="docutils literal notranslate"><span class="pre">Split()</span></code> object for lists of values that we want to
split apart into multiple rows. Just returning a list will not split the
contained items apart. Read <a class="reference internal" href="#splitting-cells"><span class="std std-ref">Splitting Cells</span></a>.</p>
</div>
<p>The resulting intermediate output will look like:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>index</p></th>
<th class="head"><p>&lt;CONCEPT.BIOSPECIMEN.ID&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>SP001A</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>SP001B</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>SP002A</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>SP002B</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>SP003A</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>SP003B</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>SP004A</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>SP004B</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>SP005A</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>SP005B</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>SP006</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>SP007</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>SP008A</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>SP008B</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>SP009A</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>SP009B</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>SP001A</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>SP001B</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>SP002A</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>SP002B</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>SP003A</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>SP003B</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>SP004A</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>SP004B</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>SP005A</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>SP005B</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>SP006</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>SP007</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>SP008A</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>SP008B</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>SP009A</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>SP009B</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>SP001A</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>SP001B</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>SP002A</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>SP002B</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>SP003A</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>SP003B</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>SP004A</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>SP004B</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>SP005A</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>SP005B</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>SP006</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>SP007</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>SP008A</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>SP008B</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>SP009A</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>SP009B</p></td>
</tr>
</tbody>
</table>
</section>
<section id="a-melt-map-operation">
<h4>A melt map operation<a class="headerlink" href="#a-melt-map-operation" title="Permalink to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">melt_map</span><span class="p">(</span>
    <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
    <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;CLEFT_EGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft ego&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CLEFT_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft id&quot;</span>
    <span class="p">},</span>
    <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
    <span class="n">map_for_values</span><span class="o">=</span><span class="n">observed_yes_no</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This says “Generate new standard concept columns for phenotype name and
observation by melting (read
<a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.melt.html">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.melt.html</a>)
the <code class="docutils literal notranslate"><span class="pre">CLEFT_EGO</span></code> and <code class="docutils literal notranslate"><span class="pre">CLEFT_ID</span></code> columns into the <cite>variables</cite> <code class="docutils literal notranslate"><span class="pre">Cleft</span> <span class="pre">ego</span></code>
and <code class="docutils literal notranslate"><span class="pre">Cleft</span> <span class="pre">id</span></code> and map the <code class="docutils literal notranslate"><span class="pre">TRUE</span></code>/<code class="docutils literal notranslate"><span class="pre">FALSE</span></code> <cite>values</cite> by passing them
through the included <code class="docutils literal notranslate"><span class="pre">observed_yes_no</span></code> function.”</p>
<p>The resulting intermediate output will look like:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>index</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.NAME&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.OBSERVED&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>Cleft ego</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
</tbody>
</table>
</section>
<section id="a-nested-operation-sub-list">
<h4>A nested operation sub-list<a class="headerlink" href="#a-nested-operation-sub-list" title="Permalink to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="n">value_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>  <span class="c1"># age (hrs) (first)</span>
        <span class="n">m</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">EVENT_AGE_DAYS</span>
    <span class="p">),</span>
    <span class="n">melt_map</span><span class="p">(</span>
        <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
        <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;CLEFT_EGO&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft ego&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CLEFT_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft id&quot;</span>
        <span class="p">},</span>
        <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
        <span class="n">map_for_values</span><span class="o">=</span><span class="n">observed_yes_no</span>
    <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Having a sub-list says “Treat the enclosed operations as a single
logically-linked unit”.</p>
<p>For this particular scenario it gives a way to say that <strong>these</strong> phenotype
columns go with <strong>this</strong> age column and not <strong>that other</strong> age column. It
should also always be possible to accomplish the same thing by making a
separate extract configuration file for those operations.</p>
<p>The resulting intermediate output for both of these operations together will
look like:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>index</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.EVENT_AGE_DAYS&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.NAME&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.OBSERVED&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0.166667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>18.125</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>1.416667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>0.166667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>14.375</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>1.416667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>1.416667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>1814.375</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>0.208333</p></td>
<td><p>Cleft ego</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>0.166667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>18.125</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>1.416667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>0.166667</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>14.375</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>1.416667</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>1.416667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>1814.375</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>0.208333</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="the-final-extraction-product">
<h3>The final Extraction product<a class="headerlink" href="#the-final-extraction-product" title="Permalink to this heading">¶</a></h3>
<p>Once all of the operations are complete and the extract stage has done its
magic, the final extracted result given the data and our configuration is:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>index</p></th>
<th class="head"><p>&lt;CONCEPT.PARTICIPANT.ID&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PARTICIPANT.MOTHER_ID&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PARTICIPANT.FATHER_ID&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PARTICIPANT.GENDER&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.BIOSPECIMEN.ID&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.EVENT_AGE_DAYS&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.NAME&gt;</p></th>
<th class="head"><p>&lt;CONCEPT.PHENOTYPE.OBSERVED&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>Female</p></td>
<td><p>SP001A</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>Female</p></td>
<td><p>SP001B</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>2</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP002A</p></td>
<td><p>18.125</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>2</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP002B</p></td>
<td><p>18.125</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>3</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP003A</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>3</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP003B</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>4</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
<td><p>Male</p></td>
<td><p>SP004A</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>4</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
<td><p>Male</p></td>
<td><p>SP004B</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>5</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP005A</p></td>
<td><p>14.375</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>5</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP005B</p></td>
<td><p>14.375</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>6</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP006</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>7</p></td>
<td><p>8</p></td>
<td><p>9</p></td>
<td><p>Male</p></td>
<td><p>SP007</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>8</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP008A</p></td>
<td><p>1814.375</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>8</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP008B</p></td>
<td><p>1814.375</p></td>
<td><p>Cleft ego</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>9</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP009A</p></td>
<td><p>0.208333333</p></td>
<td><p>Cleft ego</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>9</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP009B</p></td>
<td><p>0.208333333</p></td>
<td><p>Cleft ego</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>Female</p></td>
<td><p>SP001A</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>Female</p></td>
<td><p>SP001B</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>2</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP002A</p></td>
<td><p>18.125</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>2</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP002B</p></td>
<td><p>18.125</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>3</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP003A</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>3</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP003B</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>4</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
<td><p>Male</p></td>
<td><p>SP004A</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>4</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
<td><p>Male</p></td>
<td><p>SP004B</p></td>
<td><p>0.166666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>5</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP005A</p></td>
<td><p>14.375</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>5</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP005B</p></td>
<td><p>14.375</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>6</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP006</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>7</p></td>
<td><p>8</p></td>
<td><p>9</p></td>
<td><p>Male</p></td>
<td><p>SP007</p></td>
<td><p>1.416666667</p></td>
<td><p>Cleft id</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>8</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP008A</p></td>
<td><p>1814.375</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>8</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP008B</p></td>
<td><p>1814.375</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>9</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP009A</p></td>
<td><p>0.208333333</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>9</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP009B</p></td>
<td><p>0.208333333</p></td>
<td><p>Cleft id</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>Female</p></td>
<td><p>SP001A</p></td>
<td><p>0.166666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>Female</p></td>
<td><p>SP001B</p></td>
<td><p>0.166666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>2</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP002A</p></td>
<td><p>18.125</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>2</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP002B</p></td>
<td><p>18.125</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>3</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP003A</p></td>
<td><p>1.416666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>3</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP003B</p></td>
<td><p>1.416666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>4</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
<td><p>Male</p></td>
<td><p>SP004A</p></td>
<td><p>0.166666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>4</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
<td><p>Male</p></td>
<td><p>SP004B</p></td>
<td><p>0.166666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>5</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP005A</p></td>
<td><p>1.416666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>5</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP005B</p></td>
<td><p>1.416666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>6</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP006</p></td>
<td><p>1814.375</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>7</p></td>
<td><p>8</p></td>
<td><p>9</p></td>
<td><p>Male</p></td>
<td><p>SP007</p></td>
<td><p>0.208333333</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>8</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP008A</p></td>
<td><p>2.166666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>8</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP008B</p></td>
<td><p>2.166666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>9</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP009A</p></td>
<td><p>1.041666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Positive</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>9</p></td>
<td></td>
<td></td>
<td></td>
<td><p>SP009B</p></td>
<td><p>1.041666667</p></td>
<td><p>Extra eardrum</p></td>
<td><p>Positive</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="preprocessing-before-the-operations-list">
<span id="extract-preprocessing"></span><h2>Preprocessing Before the Operations List<a class="headerlink" href="#preprocessing-before-the-operations-list" title="Permalink to this heading">¶</a></h2>
<p>Source data can’t always be mapped right away, or perhaps your preferred
mapping operations require an initial pre-processing step, like e.g.
transposing the table to turn rows into columns.</p>
<p>Initial manipulations can be done in a <code class="docutils literal notranslate"><span class="pre">do_after_read</span></code> function that you may
optionally define in your extract configuration file like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function will be called before performing the mapping operations list.</span>
<span class="k">def</span> <span class="nf">do_after_read</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># do something with df</span>
    <span class="k">return</span> <span class="n">new_df</span>
</pre></div>
</div>
</section>
<section id="files-that-need-custom-readers">
<span id="extract-custom-reader"></span><h2>Files That Need Custom Readers<a class="headerlink" href="#files-that-need-custom-readers" title="Permalink to this heading">¶</a></h2>
<p>Source data can’t always be read automatically by the default tabular read
functions. We provide readers for CSV/TSV/Excel sheets, but maybe the data you
need is embedded in a PDF or PowerPoint file.</p>
<p>If the right reader cannot be automatically inferred, you can define a custom
function called <code class="docutils literal notranslate"><span class="pre">source_data_read_func</span></code> that takes a local file path and
keyword arguments (also given in <code class="docutils literal notranslate"><span class="pre">source_data_read_params</span></code>) and returns a
pandas DataFrame:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># a special custom file reader which must return a pandas DataFrame</span>
<span class="k">def</span> <span class="nf">source_data_read_func</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">my_df</span>
</pre></div>
</div>
</section>
<section id="predefined-mapping-operations">
<span id="map-operations"></span><h2>Predefined Mapping Operations<a class="headerlink" href="#predefined-mapping-operations" title="Permalink to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Mapping operations share common input parameters <code class="docutils literal notranslate"><span class="pre">m</span></code>, <code class="docutils literal notranslate"><span class="pre">in_col</span></code>, and
<code class="docutils literal notranslate"><span class="pre">out_col</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">in_col</span></code>: The name or numerical index of the column in the input data file.</p>
<p><code class="docutils literal notranslate"><span class="pre">out_col</span></code>: The name of the standard concept to use for the output column in
the DataFrame containing extracted data.</p>
<p><code class="docutils literal notranslate"><span class="pre">m</span></code>: The magic (or the “map”). Depending on the mapping operation, this
will be a dict, function, or constant value.</p>
</div>
<aside class="sidebar">
<p class="sidebar-title">When to use keep_map</p>
<p>You have a column of file names that you want to preserve exactly.</p>
</aside>
<section id="keep-map">
<h3>Keep Map<a class="headerlink" href="#keep-map" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">keep_map</span><span class="p">(</span><span class="n">in_col</span><span class="p">,</span> <span class="n">out_col</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">keep_map</span></code> operation copies all of the values from <code class="docutils literal notranslate"><span class="pre">in_col</span></code> to
<code class="docutils literal notranslate"><span class="pre">out_col</span></code> without modifying the values.</p>
<p><code class="docutils literal notranslate"><span class="pre">keep_map</span></code> is a special case of <code class="docutils literal notranslate"><span class="pre">value_map</span></code> with <code class="docutils literal notranslate"><span class="pre">m=lambda</span> <span class="pre">x:</span> <span class="pre">x</span></code>.</p>
<aside class="sidebar">
<p class="sidebar-title">When to use constant_map</p>
<p>You know that all of your genomic files came from Whole Genome Sequencing.</p>
</aside>
</section>
<section id="constant-map">
<h3>Constant Map<a class="headerlink" href="#constant-map" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">constant_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">out_col</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">constant_map</span></code> operation writes <cite>N</cite> iterations of constant value <code class="docutils literal notranslate"><span class="pre">m</span></code>
to <code class="docutils literal notranslate"><span class="pre">out_col</span></code>, where <cite>N</cite> is the number of rows in the source data table.</p>
<p><code class="docutils literal notranslate"><span class="pre">constant_map</span></code> is a special case of <code class="docutils literal notranslate"><span class="pre">value_map</span></code> with <code class="docutils literal notranslate"><span class="pre">m=lambda</span> <span class="pre">x:</span> <span class="pre">&lt;some</span>
<span class="pre">constant&gt;</span></code>.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Only use <code class="docutils literal notranslate"><span class="pre">constant_map</span></code> for <span class="underline">columns that are not in the
data</span>. Why? What if the column is 99% one value, so you think “I’ll just
constant map to that value”, but then you change the other 1% of values
accidentally because you never saw them? Or what if the next version of the
data introduces a new value? Your error. Don’t do it. Use <code class="docutils literal notranslate"><span class="pre">value_map</span></code>
instead for existing columns.</p>
</div>
<aside class="sidebar">
<p class="sidebar-title">When to use value_map</p>
<p>Your data uses 1/2/3/4 instead of Male/Female/Other/Unknown.</p>
</aside>
</section>
<section id="value-map">
<h3>Value Map<a class="headerlink" href="#value-map" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">value_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">in_col</span><span class="p">,</span> <span class="n">out_col</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">value_map</span></code> operation takes values from <code class="docutils literal notranslate"><span class="pre">in_col</span></code>,
performs some transformation <code class="docutils literal notranslate"><span class="pre">m</span></code> on them, and then writes the
result to <code class="docutils literal notranslate"><span class="pre">out_col</span></code> in your result dataframe.</p>
<p><code class="docutils literal notranslate"><span class="pre">m</span></code> can be a function, dict, or regex pattern string:</p>
<ul class="simple">
<li><p>If it’s a function, the returned column values will be the result of applying
that function to each value in <code class="docutils literal notranslate"><span class="pre">in_col</span></code>.</p></li>
<li><p>If it’s a dict, each key is a regex pattern string, and each value is either
a direct replacement or a function applied to values in <code class="docutils literal notranslate"><span class="pre">in_col</span></code> matching
the pattern.</p></li>
<li><p>If it’s a regex pattern string, the result is the same as if it had been
<code class="docutils literal notranslate"><span class="pre">{m:</span> <span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">x}</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Regex patterns without <code class="docutils literal notranslate"><span class="pre">^</span></code> and <code class="docutils literal notranslate"><span class="pre">$</span></code> anchors will have them automatically
added.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">m</span></code> dict regex pattern matches are checked in order, and values from
<code class="docutils literal notranslate"><span class="pre">in_col</span></code> are each only matched once, so <code class="docutils literal notranslate"><span class="pre">{&quot;a&quot;:</span> <span class="pre">&quot;b&quot;,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">&quot;c&quot;}</span></code> will
never convert “a” into “c”.</p></li>
<li><p>If a regex pattern includes capture groups, the receiving function will
receive only the captures instead of the whole cell value.</p></li>
</ul>
</div>
<aside class="sidebar">
<p class="sidebar-title">When to use row_map</p>
<p>Your data has one column for folder path and one for filename but you need
a column that combines both into a full file path.</p>
</aside>
</section>
<section id="row-map">
<h3>Row Map<a class="headerlink" href="#row-map" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">row_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">out_col</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">row_map</span></code> operation lets you build a single output column using data from
across entire rows of source data when your output column needs to combine data
from multiple cells in the row. <code class="docutils literal notranslate"><span class="pre">m</span></code> is a function that takes an entire row as
input and returns a single value using values from that row.</p>
<aside class="sidebar">
<p class="sidebar-title">When to use column_map</p>
<p>You have an input column where some cells just say “ditto”, meaning that
you need to propagate values from the cells above.</p>
</aside>
</section>
<section id="column-map">
<h3>Column Map<a class="headerlink" href="#column-map" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">column_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">in_col</span><span class="p">,</span> <span class="n">out_col</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">column_map</span></code> operation lets you pass an entire column of data into a
custom function <code class="docutils literal notranslate"><span class="pre">m</span></code> which returns a new column (of the same length) as the
result.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Needing to use <code class="docutils literal notranslate"><span class="pre">column_map</span></code> is a sign that the original data is
poorly constructed.</p>
</div>
<aside class="sidebar">
<p class="sidebar-title">When to use melt_map</p>
<p>Column headers are phenotype names, and cell values are +/- for
each name for each person, and you need to get one column with names and
one column with Yes/No values.</p>
</aside>
</section>
<section id="melt-map">
<h3>Melt Map<a class="headerlink" href="#melt-map" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">melt_map</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">map_for_vars</span><span class="p">,</span> <span class="n">value_name</span><span class="p">,</span> <span class="n">map_for_values</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">melt_map</span></code> operation combines the pandas melt function and the
<code class="docutils literal notranslate"><span class="pre">value_map</span></code> operation. It both reshapes data and maps values.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">var_name</span></code> is the melt’s resulting var column name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">map_for_vars</span></code> is a dict with keys equal to column names or numeric indices
from the source data and values equal to replacement var names.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">value_name</span></code> is the melt’s resulting value column name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">map_for_values</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">value_map</span></code>’s <code class="docutils literal notranslate"><span class="pre">m</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any use of <code class="docutils literal notranslate"><span class="pre">melt_map</span></code> can be replaced by multiple uses of <code class="docutils literal notranslate"><span class="pre">value_map</span></code>
with appropriate column stacking.</p>
</div>
<aside class="sidebar">
<p class="sidebar-title">When to use df_map</p>
<p>When you have no other option.</p>
</aside>
</section>
<section id="df-map">
<h3>DF Map<a class="headerlink" href="#df-map" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">df_map</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">df_map</span></code> operation is for when you just can’t figure out how to do what
you want to do with the other predefined operations. Take a whole DataFrame,
perform some function <code class="docutils literal notranslate"><span class="pre">m</span></code> on it, and return a new DataFrame of the same size.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You’ll probably never use <code class="docutils literal notranslate"><span class="pre">df_map</span></code>. That’s fine. It’s there for geometric
completeness. Needing to use it is a sign that the original data is poorly
constructed.</p>
</div>
</section>
</section>
<section id="important-strategic-details">
<span id="strategic-mapping-details"></span><h2>Important Strategic Details<a class="headerlink" href="#important-strategic-details" title="Permalink to this heading">¶</a></h2>
<section id="avoid-hard-coded-strings">
<h3>Avoid Hard-coded Strings<a class="headerlink" href="#avoid-hard-coded-strings" title="Permalink to this heading">¶</a></h3>
<p>Avoid using hard-coded strings for output column headers and values. As much as
possible, favor variables in <code class="docutils literal notranslate"><span class="pre">common.constants</span></code> for cell values and variables
in <code class="docutils literal notranslate"><span class="pre">common.concept_schema.CONCEPT</span></code> for <code class="docutils literal notranslate"><span class="pre">out_col</span></code> assignment. That way
everyone has the chance to use the same shared set of values.</p>
</section>
<section id="repeated-information">
<h3>Repeated Information<a class="headerlink" href="#repeated-information" title="Permalink to this heading">¶</a></h3>
<p>Multiple identical declarations don’t add new information and therefore don’t
matter. They also don’t hurt anything. This table means exactly the same thing
as if it had only one row:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Participant ID</p></th>
<th class="head"><p>Specimen ID</p></th>
<th class="head"><p>Participant Age</p></th>
<th class="head"><p>Participant Sex</p></th>
<th class="head"><p>Participant Race</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>P1</p></td>
<td><p>S1</p></td>
<td><p>7</p></td>
<td><p>m</p></td>
<td><p>unknown</p></td>
</tr>
<tr class="row-odd"><td><p>P1</p></td>
<td><p>S1</p></td>
<td><p>7</p></td>
<td><p>m</p></td>
<td><p>unknown</p></td>
</tr>
</tbody>
</table>
</section>
<section id="you-don-t-need-to-extract-the-whole-document-all-at-once">
<span id="normalized-denormalized"></span><h3>You Don’t Need To Extract The Whole Document All At Once<a class="headerlink" href="#you-don-t-need-to-extract-the-whole-document-all-at-once" title="Permalink to this heading">¶</a></h3>
<p>If creating multiple extraction configurations for a single source data file to
generate multiple smaller tables during Extract that can be manipulated in a
Transform function is easier for you than making one complex table for the
whole data file, then do it. If not, that’s fine too.</p>
</section>
<section id="parallel-column-stacking">
<span id="column-stacking"></span><h3>Parallel Column Stacking<a class="headerlink" href="#parallel-column-stacking" title="Permalink to this heading">¶</a></h3>
<p>If the same <code class="docutils literal notranslate"><span class="pre">out_col</span></code> is used multiple times, the column output from
successive operations will be vertically concatenated.</p>
<img alt="../../_images/columns.svg" src="../../_images/columns.svg" /></section>
<section id="length-rectification">
<h3>Length Rectification<a class="headerlink" href="#length-rectification" title="Permalink to this heading">¶</a></h3>
<p>The length disparity between output columns produced by <a class="reference internal" href="#parallel-column-stacking">Parallel Column
Stacking</a> is then rectified by least-common-multiple repetition of output
columns which gives a final result that preserves row colinearity from the
original source data. Note in the next image that A is inline with A, B is
inline with B, etc.</p>
<img alt="../../_images/length_rectification.svg" src="../../_images/length_rectification.svg" /><div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The lengths of all output columns <strong>must</strong> be multiples of the original
source data length. If they aren’t, the library will raise an error.</p>
</div>
</section>
<section id="splitting-cells">
<span id="id2"></span><h3>Splitting Cells<a class="headerlink" href="#splitting-cells" title="Permalink to this heading">¶</a></h3>
<p>Sometimes you will have source documents that lump multiple distinct values
into the same table cell. For instance, study participants might have multiple
specimens reported together as follows:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Participant</p></th>
<th class="head"><p>Specimens</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>P1</p></td>
<td><p>SP1a/SP1b</p></td>
</tr>
<tr class="row-odd"><td><p>P2</p></td>
<td><p>SP2</p></td>
</tr>
<tr class="row-even"><td><p>P3</p></td>
<td><p>SP3a/SP3b/SP3c</p></td>
</tr>
</tbody>
</table>
<p>Because of the practical implications of the <a class="reference internal" href="../../design/value_principles.html#value-principles"><span class="std std-ref">Value Principles</span></a>,
you will want to have independent associations (P1, SP1a), (P1, SP1b), etc, so
you need to separate the “/”-delimited specimen values into separate entries.
Replacing each of the Specimens cells with the appropriate <code class="docutils literal notranslate"><span class="pre">Split</span></code> object
will tell the Extract Stage to do the right thing.</p>
<section id="the-split-object">
<h4>The Split Object<a class="headerlink" href="#the-split-object" title="Permalink to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Split</span></code> object (<code class="docutils literal notranslate"><span class="pre">common.pandas_utils.Split</span></code>) is instantiated with a
list of values and optionally a group ID. After all of the extract mapping
operations are finished, any Split objects found in your output will trigger a
“split” of the row into multiple rows with identical non-Split cells and each
with a different value from among the Split members.</p>
<p>For instance, from:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Split([1, 2, 3])</p></td>
<td><p>Split([4, 5, 6])</p></td>
<td><p>7</p></td>
</tr>
</tbody>
</table>
<p>to:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>5</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>6</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>5</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>6</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>5</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>6</p></td>
<td><p>7</p></td>
</tr>
</tbody>
</table>
<p>Without groups, multiple Splits on the same row will multiply to produce the
cartesian product of the values in those Splits. However, if Splits are
assigned a group value, then Splits on the same row in the same group will be
linked to each other so that they do not form a cartesian product with each
other.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Split([8, 9], group=1)</p></td>
<td><p>Split([10, 11, 12], group=1)</p></td>
<td><p>13</p></td>
</tr>
</tbody>
</table>
<p>to:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>8</p></td>
<td><p>10</p></td>
<td><p>13</p></td>
</tr>
<tr class="row-odd"><td><p>9</p></td>
<td><p>11</p></td>
<td><p>13</p></td>
</tr>
<tr class="row-even"><td><p>None</p></td>
<td><p>12</p></td>
<td><p>13</p></td>
</tr>
</tbody>
</table>
<p>And if you combine both of these forms together, you go from:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Split([1, 2], group=1)</p></td>
<td><p>Split([3, 4, 5], group=1)</p></td>
<td><p>Split([6, 7])</p></td>
</tr>
</tbody>
</table>
<p>to:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>3</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>4</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-even"><td><p>None</p></td>
<td><p>5</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>3</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>None</p></td>
<td><p>5</p></td>
<td><p>7</p></td>
</tr>
</tbody>
</table>
<p>Going back to the participants and specimens example, you might use a <code class="docutils literal notranslate"><span class="pre">Split</span></code>
object as part of a <code class="docutils literal notranslate"><span class="pre">value_map</span></code> operation like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">value_map</span><span class="p">(</span>
    <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;Specimens&quot;</span><span class="p">,</span>
    <span class="n">out_col</span><span class="o">=</span><span class="s2">&quot;&lt;example_output_col&gt;&quot;</span><span class="p">,</span>
    <span class="n">m</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Split</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Interpretation of <code class="docutils literal notranslate"><span class="pre">Split</span></code> objects happens after all the mapping
operations are complete, so the newly created rows will not be affected by
the length-multiple restriction cautioned in <a class="reference internal" href="#parallel-column-stacking">Parallel Column Stacking</a>.</p>
</div>
</section>
</section>
<section id="nested-operations-sublists">
<span id="nested-operation-sublists"></span><h3>Nested Operations Sublists<a class="headerlink" href="#nested-operations-sublists" title="Permalink to this heading">¶</a></h3>
<p>You can nest groups of operations inside of sublists to do length rectification
on just the group before joining it with the rest of the operations output.</p>
<p>It looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span>
        <span class="c1"># operations group 1</span>
    <span class="p">],</span>
    <span class="p">[</span>
        <span class="c1"># operations group 2</span>
    <span class="p">],</span>
    <span class="c1"># etc</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The reason for doing this is that <a class="reference internal" href="#parallel-column-stacking">Parallel Column Stacking</a> can lead to row
mismatch problems in scenarios where several columns form logical groups with
each other and the mapping operations don’t all produce the same length output.</p>
<p>Consider the situation of extracting KFDRC phenotypes from:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Participant</p></th>
<th class="head"><p>Age</p></th>
<th class="head"><p>Mass</p></th>
<th class="head"><p>Cleft Ear</p></th>
<th class="head"><p>Mass/Cleft Age</p></th>
<th class="head"><p>Tennis Fingers</p></th>
<th class="head"><p>Tennis Age</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>P1</p></td>
<td><p>70</p></td>
<td><p>yes</p></td>
<td><p>yes</p></td>
<td><p>60</p></td>
<td><p>no</p></td>
<td><p>65</p></td>
</tr>
<tr class="row-odd"><td><p>P2</p></td>
<td><p>80</p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
<td><p>80</p></td>
<td><p>no</p></td>
<td><p>45</p></td>
</tr>
</tbody>
</table>
<p>Note that there are two different groups of phenotype measurements recorded at
different ages.</p>
<p>A naïve and incorrect approach would be to do this:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">melt_map</span><span class="p">(</span>
        <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
        <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Mass&quot;</span><span class="p">:</span> <span class="s2">&quot;Mass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Cleft Ear&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft Ear&quot;</span>
        <span class="p">},</span>
        <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
        <span class="n">map_for_values</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;yes&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">,</span>
            <span class="s2">&quot;no&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">NEGATIVE</span>
        <span class="p">}</span>
    <span class="p">),</span>
    <span class="n">keep_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;Mass/Cleft Age&quot;</span><span class="p">,</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">EVENT_AGE_DAYS</span>
    <span class="p">),</span>
    <span class="n">melt_map</span><span class="p">(</span>
        <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
        <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Tennis Fingers&quot;</span><span class="p">:</span> <span class="s2">&quot;Tennis Fingers&quot;</span>
        <span class="p">},</span>
        <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
        <span class="n">map_for_values</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;yes&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">,</span>
            <span class="s2">&quot;no&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">NEGATIVE</span>
        <span class="p">}</span>
    <span class="p">),</span>
    <span class="n">keep_map</span><span class="p">(</span>
        <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;Tennis Age&quot;</span><span class="p">,</span>
        <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">EVENT_AGE_DAYS</span>
    <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
<p>But this will cause the following <strong>bad</strong> result because the operations stack
output columns with different length outputs:</p>
<img alt="../../_images/bad_melt.svg" src="../../_images/bad_melt.svg" /><p>Then the <a class="reference internal" href="#length-rectification">Length Rectification</a> will produce this mess:</p>
<img alt="../../_images/wrong.svg" src="../../_images/wrong.svg" /><p>If you need to group values together and also stack columns that belong to the
groups, all of the columns in each group must be the same length, otherwise
groups will invade each others’ space. When melting multiple columns, this is
naturally not going to be the case.</p>
<p>Putting each of the groups in its own nested sublist solves this problem by
rectifying lengths for each of the groups independently first.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span>   <span class="c1"># mass/cleft group</span>
        <span class="n">melt_map</span><span class="p">(</span>
            <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
            <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Mass&quot;</span><span class="p">:</span> <span class="s2">&quot;Mass&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Cleft Ear&quot;</span><span class="p">:</span> <span class="s2">&quot;Cleft Ear&quot;</span>
            <span class="p">},</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
            <span class="n">map_for_values</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;yes&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">,</span>
                <span class="s2">&quot;no&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">NEGATIVE</span>
            <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">keep_map</span><span class="p">(</span>
            <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;Mass/Cleft Age&quot;</span><span class="p">,</span>
            <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">EVENT_AGE_DAYS</span>
        <span class="p">),</span>
    <span class="p">],</span>
    <span class="p">[</span>   <span class="c1"># tennis fingers group</span>
        <span class="n">melt_map</span><span class="p">(</span>
            <span class="n">var_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
            <span class="n">map_for_vars</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Tennis Fingers&quot;</span><span class="p">:</span> <span class="s2">&quot;Tennis Fingers&quot;</span>
            <span class="p">},</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="p">,</span>
            <span class="n">map_for_values</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;yes&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">,</span>
                <span class="s2">&quot;no&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">OBSERVED</span><span class="o">.</span><span class="n">NEGATIVE</span>
            <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">keep_map</span><span class="p">(</span>
            <span class="n">in_col</span><span class="o">=</span><span class="s2">&quot;Tennis Age&quot;</span><span class="p">,</span>
            <span class="n">out_col</span><span class="o">=</span><span class="n">CONCEPT</span><span class="o">.</span><span class="n">PHENOTYPE</span><span class="o">.</span><span class="n">EVENT_AGE_DAYS</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
<p>So now you get this instead:</p>
<img alt="../../_images/good_melt.svg" src="../../_images/good_melt.svg" /></section>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../testing.html" class="btn btn-neutral float-right" title="Testing Your Ingest Package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../ingest_package.html" class="btn btn-neutral float-left" title="New Ingest Package Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Kids First

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>